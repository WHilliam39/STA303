---
title: "Gender Parity Report"
subtitle: "Analysis of fairness in hring, wages and promotion"
author: "Report prepared for Black Saber Software by White Shield Analytics"
date: 2021-04-21
lang: "en"
output:
  pdf_document:
    template: report.tex
    toc: true
    toc_depth: 2
titlepage: true
titlepage-color: "20283E"
titlepage-text-color: "FFFFFF"
titlepage-rule-color: "FFFFFF"
titlepage-rule-height: 2
---

```{r message=FALSE, include=FALSE}
library(tidyverse)
library(lme4)
library(ggplot2)
library(reshape)
library(lattice)
library(DataExplorer)
library(corrplot)
library(Hmisc)
library(nlme)
library(ggbeeswarm)
library(lmtest)

# this should supress all code and messages
knitr::opts_chunk$set(include=FALSE)
```

# General comments (you can delete this section) Test Test 

_You can delete this section, and if you want to check what it said, just open a template from the package again. You don't have to use this particular template, but you DO need to write you report in RMarkdown and include a cover page._

_The cover page must have:_

*	_A title and subtitle_
* _"Report prepared for Black Saber Software by" your company name_
*	_Date (assessment submission date is fine)_

_You can change the colour of this cover to any colour you would like by replacing 6C3082 in the YAML above (line 11) to another hex code. You could use this tool to help you:_ https://htmlcolorcodes.com/color-picker/

\newpage
# Executive summary

_Guidelines for the executive summary:_

* _No more than two pages_
* _Language is appropriate for a non-technical audience_
* _Bullet points are used where appropriate_
*	_A small number of key visualizations and/or tables are included_
*	_All three research questions are addressed_

(add more)This study assesses ethnicity/race fairness in hiring, promotion, and salary processes based on the existing employees and hiring data from Black Saber Software.   

We estimate that, 

The results of the study are summarized below.  

* _1_
* _1_
* _1_
*	_1_
*	_1_
  
The key results of the study are summarized in the following tables.  

\newpage
# Technical report
_This part of the report is much more comprehensive than the executive summary. The audience is statistics/data-minded people, but you should NOT include code or unformatted R output here._


## Introduction

_Provide a brief introduction to your report and outline what the report will cover. This section is valuable for setting scope and expectations. _

### Research questions:
_Use bullet points to to describe the research questions you are going to address. Write in full sentences._

* _Q1_
* _Q2_
* _Q3_

## Informative title for section addressing a research question (question 1 Hiring)

_For each research question, you will want to briefly describe any data manipulation, show some exploratory plots/summary tables, report on any methods you use (i.e. models you fit) and the conclusions you draw from these_
```{r include=FALSE}
#extract hiring data
final_hiring<-read_csv("data/final-hires-newgrad_2020.csv")
phase1<-read_csv("data/phase1-new-grad-applicants-2020.csv")
phase2<-read_csv("data/phase2-new-grad-applicants-2020.csv")
phase3<-read_csv("data/phase3-new-grad-applicants-2020.csv")
```

```{r include=FALSE}
#get final hiring all detailed info
combine_phase2_phase3<-inner_join(phase2,phase3,by="applicant_id")
final_hiring<-inner_join(combine_phase2_phase3,final_hiring,by="applicant_id")
#get full table of all applicants
combine_phase1_phase2<-left_join(phase1,phase2,keep=FALSE)
all_phase<-left_join(combine_phase1_phase2,phase3,keep=FALSE)
```

```{r include=FALSE}
#get hiring status
all_phase$status<-ifelse(all_phase$applicant_id %in% final_hiring$applicant_id,"Hired",
                  ifelse(all_phase$applicant_id %in% phase1$applicant_id,"Rejected"))
all_phase<-as.data.frame(unclass(all_phase))
all_phase$applicant_id<-as.character(all_phase$applicant_id)
```

```{r}
#gender distribution on status
all_phase%>%ggplot(aes(x=status,fill=gender))+geom_bar(position = "fill")+theme_minimal()+
  labs(title="Gender distribution in hiring status, Black Saber Software",
      x="Status",
      y="Percentage",
      caption=str_c("Created by: White Sheild Analytics\n","Source: Black Saber Software\n"))+
  scale_fill_brewer(palette = "Pastel2")
ggsave("images/hiring_status.png",width = 7, height = 4)
```
![](images/hiring_status.png)
```{r}
#gender distribution on interview score
all_phase%>%ggplot(aes(x=interviewer_rating_1,y=interviewer_rating_2, color=gender))+geom_point(size=3)+theme_minimal()+
  labs(title="Interview score with race, Black Saber Software",
      x="Interview 1 rating",
      y="Interview 2 rating",
      caption=str_c("Created by: White Sheild Analytics\n","Source: Black Saber Software\n"))+
  scale_color_brewer(palette = "Pastel2")
ggsave("images/hiring_interview.png",width = 7, height = 4)
```
![](images/hiring_interview.png)
```{r}
#gender distribution on GPA
all_phase%>%ggplot(aes(x=status,y=gpa, color=gender))+geom_quasirandom(size=1)+coord_flip()+geom_hline(yintercept=3, linetype="dashed",color = "orange")+theme_minimal()+ylim(1,4)+labs(title="Applicant GPA with hiring status, Black Saber Software",
      x="Hiring Status",
      y="GPA",
      caption=str_c("Created by: White Sheild Analytics\n","Source: Black Saber Software\n"))+
  scale_color_brewer(palette = "Pastel2")
ggsave("images/hiring_gdp.png",width = 7, height = 4)
```
![](images/hiring_gdp.png)
```{r}
#gender distribution on technical skill score
all_phase%>%ggplot(aes(x=technical_skills,color=gender))+geom_freqpoly(binwidth=10,size=2)+theme_minimal()+labs(title="Technical skill score distribution with race, Black Saber Software",
      x="Number of applicants",
      y="Score",
      caption=str_c("Created by: White Sheild Analytics\n","Source: Black Saber Software\n"))+
  scale_color_brewer(palette = "Pastel2")
ggsave("images/hiring_techskill.png",width = 7, height = 4)
```
![](images/hiring_techskill.png)
```{r}
#gender distribution on writing skill score
all_phase%>%ggplot(aes(x=writing_skills,fill=gender))+geom_histogram(binwidth=3)+theme_minimal()+
  labs(title="Writing skill score distribution with race, Black Saber Software",
      x="Number of applicants",
      y="Score",
      caption=str_c("Created by: White Sheild Analytics\n","Source: Black Saber Software\n"))+
  scale_fill_brewer(palette = "Pastel2")
ggsave("images/hiring_writingskill.png",width = 7, height = 4)
```
![](images/hiring_writingskill.png)
```{r}
#gender distribution on speaking skill
all_phase%>%ggplot(aes(x=speaking_skills,fill=gender))+geom_bar(position = "fill")+xlab("Socre")+ylab("Percentage")+theme_minimal()+coord_flip()+
  labs(title="Speaking skill score distribution with race, Black Saber Software",
      x="Score",
      y="Percentage",
      caption=str_c("Created by: White Sheild Analytics\n","Source: Black Saber Software\n"))+
  scale_fill_brewer(palette = "Pastel2")
ggsave("images/hiring_speakingskill.png",width = 7, height = 4)
```
![](images/hiring_speakingskill.png)
```{r}
#gender distribution on leadership presence
all_phase%>%ggplot(aes(x=leadership_presence,fill=gender))+geom_bar(position = "fill")+xlab("Socre")+ylab("Percentage")+theme_minimal()+coord_flip()+
  labs(title="Leadership presence score distribution with race, Black Saber Software",
      x="Score",
      y="Percentage",
      caption=str_c("Created by: White Sheild Analytics\n","Source: Black Saber Software\n"))+
  scale_fill_brewer(palette = "Pastel2")
ggsave("images/hiring_leadership.png",width = 7, height = 4)
```
![](images/hiring_leadership.png)

```{r include=FALSE}
#create binary variable for each of the phase
phase1$result<-ifelse(phase1$applicant_id%in%phase2$applicant_id,'Proceed','NO')
phase2$result<-ifelse(phase2$applicant_id%in%phase3$applicant_id,'Proceed','NO')
combine_phase2_phase3$result<-ifelse(combine_phase2_phase3$applicant_id%in%final_hiring$applicant_id,'Proceed','NO')
all_phase$result<-ifelse(all_phase$applicant_id%in%final_hiring$applicant_id,'Hired','NO')
```

```{r include=FALSE}
#fit mixed logistic regression model
phase1<-as.data.frame(unclass(phase1))
model1<-glmer(as.factor(result)~gpa+gender+extracurriculars+work_experience+
                (1|applicant_id),data = phase1,family = binomial,nAGQ = 10)
summary(model1)
```

```{r include=FALSE}
#fit mixed logistic regression model
phase2<-as.data.frame(unclass(phase2))
model2<-glmer(as.factor(result)~gpa+gender+technical_skills+writing_skills+leadership_presence+speaking_skills+(1|applicant_id),data = phase2,family = binomial)
summary(model2)
```

```{r include=FALSE}
#fit mixed logistic regression model
combine_phase2_phase3<-as.data.frame(unclass(combine_phase2_phase3))
model3<-glmer(as.factor(result)~gpa+gender+log(interviewer_rating_1)+log(interviewer_rating_2)+(1|applicant_id),data = combine_phase2_phase3,family = binomial)
summary(model3)
```

## 2. Is there a gender wage gap in Black Saber?

```{r, echo=FALSE, results='hide', fig.show='hide'}
# data wrangling for research questions 2 and 3

# read in the data
black_saber_current_employees <- read_csv("data/black-saber-current-employees.csv")

# exploratory data analysis on current employees:
current_employee <- black_saber_current_employees
summary(current_employee)

# change variable data types:
current_employee$employee_id <- as.character(current_employee$employee_id)
current_employee$gender <- as.factor(current_employee$gender)
current_employee$team <- as.factor(current_employee$team)
current_employee$role_seniority <- as.factor(current_employee$role_seniority)
current_employee$leadership_for_level <- as.factor(current_employee$leadership_for_level)

current_employee$salary <- gsub("\\$", "", current_employee$salary)
current_employee$salary <- gsub("\\,", "", current_employee$salary)
current_employee$salary <- as.numeric(current_employee$salary)

# basic plot about current_employee data:
plot_histogram(current_employee)

# correlation between productivity and salary:
cor(current_employee$productivity,current_employee$salary)

```


```{r, echo=FALSE, results='hide', fig.show='hide'}
# exploratory data analysis for gender wage gap:

# boxplot on productivity grouped by gender:
plot_boxplot(current_employee, title = "Boxplot of productivity and salary grouped by gender",by = "gender", geom_boxplot_args = list("outlier.color" = "grey"))
ggsave("images/productivity_salary_box.png",width = 7, height = 4)

# scatterplot on the rpoductivity by salary grouped by gender:
ggplot(data = current_employee, aes(x = productivity,y=salary, colour = gender)) +
  geom_point(size=0.8)+theme_minimal()+
  labs(title="Productivity by Salary, Black Saber Software",
      x="Productivity",
      y="Salary",
      caption=str_c("Created by: White Sheild Analytics\n","Source: Black Saber Software\n"))+
  scale_color_brewer(palette = "Pastel2")
ggsave("images/productivity_salary_ggplot.png",width = 7, height = 4)

```
![Box plot of productivity and salary grouped by gender.](images/productivity_salary_box.png)
![Scatter plot of productivity by salary.](images/productivity_salary_ggplot.png)

```{r, echo=FALSE, results='hide', fig.show='hide'}
# fit models for research question 2 

# first model with fixed effects
model_salary_fixed <- gls(salary ~ gender + team + role_seniority + leadership_for_level + productivity, data=current_employee, method = "ML")
summary(model_salary_fixed)
```

```{r, echo=FALSE, results='hide'}
# fixed effects & random effects with individual team:
model_salary_mixed <- lme(salary ~ gender + role_seniority + leadership_for_level + productivity, data=current_employee, random = ~1|team, method = "ML")
summary(model_salary_mixed)
```

```{r, echo=FALSE, results='hide'}
lrtest(model_salary_fixed, model_salary_mixed)
```

## 3. Is there a gender promotion gap in Black Saber?

The third research question in our project is to identify the impact of gender during the promotion process. We collect the data from the current employees in Black Saber Software, there are total 607 employees have participated this collection. In this data frame, it includes the unique employees’ ID (employee_id), the gender of employee (gender), the team they work in (team), the financial quarter for each record (financial_q), the emplyees’level of senior (role_ seniority), the quality to measure their leadership (leadership_for_level), measure the productivity relative to job description (productivity), and quarter salary that relative to their productivity and leadership (salary).

The first step is to clean and organize this data set, we created a new variable to measure the number of promotion in his/her current career. We use the total level of senior, which is nine, to minus the number of roles that they have experienced. Then we group the productivity by employee_id and calculate the annual salary for each employee. Under each quarter, the firm would measure the performance of each employee to determine their leadership whether satisfy the role requirements, with appropriate, exceed and need improvement categories. Hence, we calculate the appearance of leadership performance from each employee under the three levels. After we finish the organization step, we have built a new data set (new_data) to analysis the impact of gender in promotion process. We choose to use the **Linear Mixed Effects Model**, because the data can separate by different groups that all observations are not completely independent to each other, such as employees can group by team, and also can group by level of senior. Therefore, this model can illustrates the random effect and fixed effect to the response variable, and we would use the likelihood test to determine which model has better performance on the data set.

```{r,echo=FALSE, results='hide', fig.show='hide'}
#create subset for # of promotion:
num_promoted <- current_employee %>% select(employee_id,role_seniority)
wip1 <- num_promoted %>% 
  group_by(employee_id) %>% count(role_seniority) %>%
  pivot_wider(names_from = role_seniority, values_from = n) 
wip1$na_count <- apply(wip1, 1, function(x) sum(is.na(x)))
wip1$num_promoted <- 9 - wip1$na_count
promoted <- wip1[,c(1,12)] 

#average productivity for every employee:
avg_prod <- current_employee %>% group_by(employee_id) %>% summarise(mean(productivity))
avg_prod

#calculate salary increase for every employee:
wip2<- current_employee %>% group_by(employee_id) %>% summarise(max(salary))
wip3 <- current_employee %>% group_by(employee_id) %>% summarise(min(salary))
salary_inc <- inner_join(wip2,wip3,mby="employee_id")
salary_inc$raise <- salary_inc$`max(salary)`-salary_inc$`min(salary)`
```

```{r,echo=FALSE, results='hide', fig.show='hide'}
#Re-join all new features with unique employee ID: 
all_employee <- inner_join(avg_prod,promoted,by="employee_id")
all_employee <- inner_join(all_employee,salary_inc,by="employee_id")
all_employee <- all_employee[,c(1,2,3,6)]
all_employee$salary_raise <- all_employee$raise
all_employee$avg_productivity <- all_employee$`mean(productivity)`
all_employee <- all_employee[,c(1,3,5,6)]

other_subset <- current_employee[,c(1:3, 6)]
leadership <- other_subset %>% 
  group_by(employee_id) %>% count(leadership_for_level) %>%
  pivot_wider(names_from = leadership_for_level, values_from = n) 
leadership[is.na(leadership)] <- 0

other_subset <- other_subset[,c(1:3)]
other_subset <- distinct(other_subset)

new_data <- inner_join(all_employee, leadership, by="employee_id")
new_data <- inner_join(new_data, other_subset, by="employee_id")
```

```{r,echo=FALSE, results='hide', fig.show='hide'}
#change variable data types:
new_data$gender <- as.factor(new_data$gender)
new_data$team <- as.factor(new_data$team)

new_data$leadership_appropriate <- new_data$`Appropriate for level`
new_data$leadership_needsimprov <- new_data$`Needs improvement`
new_data$leadership_exceeds <- new_data$`Exceeds expectations`
new_data <- new_data[,-c(5:7)]

str(new_data)
```

```{r,echo=FALSE, results='hide', fig.show='hide'}
#fixed effects & random effects:
salary_role_seniority<- lme(salary ~gender+team+role_seniority+leadership_for_level+productivity,data=current_employee,
            random = ~1|role_seniority, method = "ML") #group by role seniority
summary(salary_role_seniority)
```
Under this linear mixed effects model, it grouped by the position of senior of each employees that is the random effect of this model. The salary would increased by 3330.832 dollars on average when the level of senior increase. It shows the correlation between each variable, and the summary table illustrates the estimate and p_value of each variable. From the result on above, the female group has a negative correlation with the each level of role seniority, it represents the 
females are less likely to promote to a relative higher position than males.

```{r,echo=FALSE, results='hide', fig.show='hide'}
#Fit model:
#fixed effects & random effects:
#number of promotions as outcome variable:
model_num_promote <- lme(num_promoted ~
                           gender+team+leadership_appropriate,
                         data=new_data,random = ~1|employee_id, method = "ML")
summary(model_num_promote)
```
Under the **Linear Mixed Effects Models**, we have build a model to describe the relationship between the number of promotion and average productivity, gender and team groups, and group by employees' ID. From the model, it illustrates that the number of promotion would decreased by 0.2867 point in average when the employee is female rather than male. In addition, the p-value in female group is 0.0000, which is much less than 0.05, it represents the female group has a significant effect in this model, and it provide a strong evidence to reject the null hypothesis (everyone has the equal opportunity on promotions)

```{r,echo=FALSE, results='hide', fig.show='hide'}
model_promote_productivity<- lme(num_promoted~
                             gender+team+leadership_appropriate+avg_productivity,
                           data=new_data,random = ~1|employee_id, method = "ML")
summary(model_promote_productivity)
```
Under this liner mixed effect model, it adds a new variable to show the effect on whether the employee's leadership ability is exceed than the requirements of the level to the opportunity to promoted. From this model, the women group also has a less number of promotion than the men, but the p-value of productivity in this model is greater than 0.05, which is 0.0768. Then it represents the changing of productivity does not provide a significance difference on number of employee's promotion.

```{r}
lrtest(model_num_promote,model_promote_productivity)
```
By using the likelihood ratio test, we can find that the likelihood ratio Chi-Squared statistic and the p-value is greater than 0.05, which is 0.07373, it represents the average productivity is not an important effect when the employees have the chance to promote. On the other hand, from the boxplot result between gender and productivity, it shows that the mean of productivity in female group is higher than the male group. After combine the two results, the female group perhaps has few number of promotion and less opportunity to promote than the male.

```{r,echo=FALSE, results='hide', fig.show='hide'}
#EDA:
# scatterplot on the productivity by number of promoted grouped by gender:
ggplot(data = new_data, aes(x = avg_productivity,y=num_promoted, colour = gender)) +
  geom_quasirandom(size=1,groupOnX = FALSE)+
  theme_minimal()+
  labs(title = "Gender distribution in productivity and number of promoted",
       caption=str_c("Created by: White Sheild Analytics\n","Source: Black Saber Software\n"),x="Average productivity",y="Numbers of promotion")+
  scale_color_brewer(palette = "Pastel2")
ggsave("images/promotion_productivity.png",width = 7, height = 4)
```
![Gender Distribution on productivity by number of promotion. The females group concentrates on one or two times of promotion, though she has relative larger productivity than the males. The males group has more times to promoted than females. ](images/promotion_productivity.png)


```{r,echo=FALSE, results='hide', fig.show='hide'}
#EDA:
#role seniority on gender:
ggplot(current_employee, aes(role_seniority, ..count..)) + geom_bar(aes(fill = gender), position = "fill")+
  theme_minimal()+
  labs(title = "Gender distribution in role senority",
       caption=str_c("Created by: White Sheild Analytics\n","Source: Black Saber Software\n"),y="Percentage",x="Role Seniority")+
  scale_fill_brewer(palette = "Pastel2")
ggsave("images/gender_role_senority.png",width = 7, height = 4)
```
![Gender Ratio in Role Senority. The men has occupied a larger percentage when the position increases.](images/gender_role_senority.png)

```{r,echo=FALSE, results='hide', fig.show='hide'}
#scatterplot on the leadership exceed expectation and number of promoted
ggplot(data = new_data, aes(x = leadership_exceeds,y=num_promoted,colour = gender))+
  geom_point(size=3)+
  theme_minimal()+
  labs(title = "Gender distribution in leadership exceed expectation and number of promoted",
       caption=str_c("Created by: White Sheild Analytics\n","Source: Black Saber Software\n"),y="Leadership exceeds", x="Numbers of promotion")+
  scale_color_brewer(palette = "Pastel2")
ggsave("images/promotion_exceeds_leadship.png",width = 7, height = 4)
```
![Gender Distribution on exceeded leadership by the number of promotion. The majority of employees' leadership exceed their expectation are males.](images/promotion_exceeds_leadship.png)

```{r,echo=FALSE, results='hide', fig.show='hide'}
#leadership for level on gender:
ggplot(current_employee, aes(leadership_for_level, ..count..)) + 
  geom_bar(aes(fill = gender), position = "fill")+
  theme_minimal()+
  labs(title = "Gender distribution in leadership level",
       caption=str_c("Created by: White Sheild Analytics\n","Source: Black Saber Software\n"),x="Leadership levels",y="Percentage")+
  scale_fill_brewer(palette = "Pastel2")
ggsave("images/gender_leadership.png",width = 7, height = 4)
```
![Gender Ratio in Leadership Level. The gender in "leadership exceed expectation" category is only men, and the female has occupied above 90% in "leadership needs to improve" category](images/gender_leadership.png)

In conclusion, after analysis the linear mixed effect model with number of promotion, gender, team and leadership performance, the result shows that number of promotion would decreased by 0.2867 point in average when the employee is female rather than male, and this effect is significant in this model. From the four graphs above, the main idea is the males occupied a relative large percentage in all nine senior position, and female group has a relative smaller number to be promoted within a same level of productivity. Therefore, the gender perhaps affect the promotion process and result in Black Saber Software.

## Discussion

_In this section you will summarize your findings across all the research questions and discuss the strengths and limitations of your work. It doesn't have to be long, but keep in mind that often people will just skim the intro and the discussion of a document like this, so make sure it is useful as a semi-standalone section (doesn't have to be completely standalone like the executive summary)._

### Strengths and limitations

\newpage
# Consultant information
## Consultant profiles

**Gancheng Luo**.

**Ziqi Gao** Ziqi is a senior consultant with White Shield Analytics. She specializes in data analysis and visualization. She earnd her Bachelor of Science, Majoting in Economics and Statistics from the Univerisity of Toronto in 2021.

**Zhaowei Huang**. Zhaowei is a senior consultant with White Shield Analytics. He specializes in data visualization. Zhaowei earned his Bachelor of Science, Majoring in Statistics and Economics, Minoring in Computer Science, from the University of Toronto in 2021. 

**Lingjing Zou**. Lingjing is a senior consultant with White Shield. She specializes in data analysis and visualization. She finished Bachelor of Science with studying statistics from University of Toronto in 2021. She focuses on creating organizational and reproducible solutions with analysis, documentation and communication.

## Code of ethical conduct  

The elements have been grouped into four significant areas of responsibility to define the ethical statistical practice of White Shield Analytics.   
_A. Responsibilities to Science/Public/Funder/Client_  
1. Strive to explain clearly the foreseeable adverse consequences and effects caused by the violation of the agreed sampling and analysis plan.  
2. Display clients other statistical method options that differ in size, cost, and accuracy, but are also effective.  
3. Perform statistical sampling and analysis procedures scientifically without pre-determined conclusions.  

_B. Responsibilities to Data and Methods Integrity_  
1. Present the limitations and the possible errors of statistical inference.  
2. Report the data source and evaluate the appropriateness of the data  
3. explain all the data involved in the research and present the specific sample data used  

_C. Responsibilities to Professional_  
1. Reduce the presumption and influence of the data provider's preference on the statistical analysis and results.  
2. Respect other's contributions and intellectual property rights.  
  
_D. Responsibilities to Other Statistical Practitioners_  
1. Improve the quality of the work of others through peer review. When reviewing, respect different opinions, and do not target individuals, only evaluate methods. Strive to complete the review task comprehensively and carefully.  
2. Instill in students and non-statisticians their understanding of the practical value of the statistical concepts and methods they are learning and applying.  
